# Troubleshooting: 500 Internal Server Error from Auth-Service

## Problem

Getting `500 Internal Server Error` when calling `/auth/login`:
```
INFO: 127.0.0.1:48094 - "POST /auth/login HTTP/1.1" 500 Internal Server Error
```

**User reported:** "because i do not have api-key in auth-service"

## Important Clarification

**The gateway does NOT require API keys for backend services.** This is by design:

- ✅ API keys are used for **client-to-gateway** authentication
- ✅ Backend services should **NOT** require API keys from gateway
- ✅ Gateway handles authentication before forwarding requests

## Root Cause Analysis

The 500 error is coming from **auth-service itself**, not from the gateway. Possible causes:

1. **Database connection issue**
2. **User doesn't exist** (should return 404, but might cause 500 if error handling fails)
3. **Missing Content-Type header** (fixed in gateway)
4. **Internal service error** (check auth-service logs)

## Solutions Applied

### 1. Fixed Header Preservation

Updated `app/core/proxy.py` to preserve `Content-Type` and `Accept` headers when forwarding requests.

### 2. Request Format

Ensure correct request format:
```json
{
  "login_type": "username",
  "identifier": "alex.w",
  "password": "Ax9!kP3#Lm2Q"
}
```

## Troubleshooting Steps

### Step 1: Check Auth-Service Logs

```bash
cd /developer/Cloud_resource_management_system_platform_microservices/auth-service

# Check error logs
tail -100 logs/error.log

# Check application logs
tail -100 logs/app.log

# Check for recent errors
grep -i "error\|exception\|traceback" logs/*.log | tail -20
```

### Step 2: Test Direct Connection

```bash
# Test directly to auth-service (bypass gateway)
curl -X POST http://127.0.0.1:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "login_type": "username",
    "identifier": "alex.w",
    "password": "Ax9!kP3#Lm2Q"
  }'
```

If this also returns 500, the issue is in auth-service, not gateway.

### Step 3: Check Database Connection

```bash
# Verify database is accessible
mysql -u root -p -e "USE auth_service; SELECT 1;"

# Check if user exists
mysql -u root -p -e "USE auth_service; SELECT * FROM sys_user WHERE username='alex.w';"
```

### Step 4: Verify Auth-Service is Running

```bash
# Check if auth-service is running
ps aux | grep -E "auth|8000" | grep -v grep

# Check health endpoint
curl http://127.0.0.1:8000/health
```

### Step 5: Check Gateway Headers

After restarting gateway, verify headers are preserved:

```bash
# Enable debug logging in gateway to see forwarded headers
# Check gateway logs for forwarded request details
tail -f logs/application.log | grep "auth/login"
```

## Common Issues

### Issue 1: Database Connection Failed

**Symptoms:** 500 error, database errors in logs

**Solution:**
```bash
# Check database is running
sudo systemctl status mysql

# Verify credentials in .env.dev
cat .env.dev | grep DATABASE

# Test connection
mysql -u root -p -e "SELECT 1;"
```

### Issue 2: User Doesn't Exist

**Expected:** Should return `USER_NOT_FOUND` (404), but might cause 500 if error handling fails

**Solution:**
- Create user first, or
- Use existing user credentials

### Issue 3: Missing Content-Type Header

**Fixed:** Gateway now preserves Content-Type header automatically

**Verify:**
- Restart gateway after fix
- Test login endpoint

### Issue 4: Internal Service Error

**Symptoms:** 500 error with generic message

**Solution:**
1. Check auth-service logs for detailed error
2. Verify all dependencies are installed
3. Check database schema is correct
4. Verify Redis connection (if used)

## Gateway Configuration

### Headers Forwarded

The gateway forwards:
- ✅ `Content-Type` - From original request (now preserved)
- ✅ `Accept` - From original request (now preserved)
- ✅ `X-Request-Id` - Generated by gateway
- ✅ `X-Trace-Id` - Generated by gateway
- ✅ `X-User-Id`, `X-Roles`, etc. - If user is authenticated

The gateway does **NOT** forward:
- ❌ `X-API-Key` - Not forwarded to backend services
- ❌ `Authorization` (JWT) - Not forwarded (user context is in X-User-Id headers)

### Route Configuration

```yaml
- path: /auth/login
  service: auth-service
  methods: [POST]
  auth_required: false  # ✅ No authentication required
  rate_limit: 10
  timeout: 10
```

## Next Steps

1. **Restart Gateway:**
   ```bash
   pkill -f "uvicorn.*8001"
   cd /developer/Cloud_resource_management_system_platform_microservices/gateway-service
   python run.py
   ```

2. **Check Auth-Service Logs:**
   ```bash
   cd /developer/Cloud_resource_management_system_platform_microservices/auth-service
   tail -f logs/error.log
   ```

3. **Test Login:**
   ```bash
   curl -X POST http://localhost:8001/auth/login \
     -H "Content-Type: application/json" \
     -d '{
       "login_type": "username",
       "identifier": "alex.w",
       "password": "Ax9!kP3#Lm2Q"
     }'
   ```

## Summary

**Key Points:**
- ✅ Gateway does NOT require API keys for backend services
- ✅ Gateway now preserves Content-Type header
- ⚠️ 500 error is from auth-service, check its logs
- ✅ Use correct request format: `{"login_type": "username", "identifier": "...", "password": "..."}`

**Action Required:**
1. Check auth-service logs for detailed error
2. Verify database connection
3. Verify user exists
4. Restart gateway to apply header preservation fix
