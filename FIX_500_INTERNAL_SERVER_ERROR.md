# Fix: 500 Internal Server Error - Missing Headers

## Problem

Getting `500 Internal Server Error` when calling `/auth/login` through gateway:
```
INFO: 127.0.0.1:48094 - "POST /auth/login HTTP/1.1" 500 Internal Server Error
```

**User reported:** "because i do not have api-key in auth-service"

## Root Cause

The gateway was **not preserving important request headers** (like `Content-Type`) when forwarding requests to backend services. This can cause backend services to fail processing requests.

## Solution

### Fixed: Header Preservation in Proxy Service

Updated `app/core/proxy.py` to preserve important headers:

1. **Content-Type** - Required for POST/PUT requests with JSON body
2. **Accept** - For response format negotiation

### Code Changes

**File:** `app/core/proxy.py`

```python
# Preserve important original headers from context
if context.headers:
    # Preserve Content-Type for POST/PUT requests
    if "content-type" in context.headers:
        forward_headers["Content-Type"] = context.headers["content-type"]
    # Preserve Accept header
    if "accept" in context.headers:
        forward_headers["Accept"] = context.headers["accept"]
```

## Important Notes

### API Key Not Required

**The gateway does NOT forward API keys to backend services.** This is by design:

- API keys are used for **client-to-gateway** authentication
- Backend services should **not** require API keys from the gateway
- Gateway handles authentication/authorization before forwarding

### Headers Forwarded

The gateway forwards:
- ✅ `Content-Type` - From original request
- ✅ `Accept` - From original request
- ✅ `X-Request-Id` - Generated by gateway
- ✅ `X-Trace-Id` - Generated by gateway
- ✅ `X-User-Id`, `X-Roles`, etc. - If user is authenticated

The gateway does **NOT** forward:
- ❌ `X-API-Key` - Not forwarded to backend services
- ❌ `Authorization` (JWT) - Not forwarded (user context is in X-User-Id headers)

## Verification

### Test Direct Connection

```bash
# Test directly to auth-service (bypass gateway)
curl -X POST http://127.0.0.1:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "login_type": "username",
    "identifier": "alex.w",
    "password": "Ax9!kP3#Lm2Q"
  }'
```

### Test Through Gateway

```bash
# Test through gateway
curl -X POST http://localhost:8001/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "login_type": "username",
    "identifier": "alex.w",
    "password": "Ax9!kP3#Lm2Q"
  }'
```

## Troubleshooting

### Still Getting 500 Error?

1. **Check auth-service logs:**
   ```bash
   cd /developer/Cloud_resource_management_system_platform_microservices/auth-service
   tail -50 logs/error.log
   tail -50 logs/app.log
   ```

2. **Verify request format:**
   ```bash
   # Must use correct format
   {
     "login_type": "username",
     "identifier": "alex.w",
     "password": "Ax9!kP3#Lm2Q"
   }
   ```

3. **Check database connection:**
   ```bash
   # Verify auth-service can connect to database
   curl http://127.0.0.1:8000/health
   ```

4. **Verify user exists:**
   - Check if user "alex.w" exists in database
   - Verify password is correct

### Common Issues

#### Issue 1: User Doesn't Exist

**Error:** `USER_NOT_FOUND`

**Solution:** Create user first or use existing user

#### Issue 2: Database Connection Failed

**Error:** `500 Internal Server Error` with database errors in logs

**Solution:** 
- Check database is running
- Verify database credentials in `.env.dev`
- Test connection: `mysql -u root -p -e "USE auth_service; SELECT 1;"`

#### Issue 3: Missing Content-Type Header

**Error:** `422 Validation Error` or `500 Internal Server Error`

**Solution:** 
- Ensure `Content-Type: application/json` is in request
- Gateway now preserves this header automatically

## Summary

**Fixed:**
- ✅ Gateway now preserves `Content-Type` header
- ✅ Gateway now preserves `Accept` header
- ✅ Headers are taken from RequestContext

**Important:**
- ❌ Gateway does NOT forward API keys to backend services
- ✅ Backend services should NOT require API keys from gateway
- ✅ API keys are only for client-to-gateway authentication

**Next Steps:**
1. Restart gateway to apply fix
2. Test login endpoint
3. Check auth-service logs if still getting errors
